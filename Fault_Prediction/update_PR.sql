-- 更新 YJ_WARNING_FORECAST 表中的诊断数据列 
UPDATE "YJ_WARNING_FORECAST" P -- 预测表格p
SET
(
	"DIAGPROB",
	"DIAGTIME",
	"DIAGRECORDID"
) =      -- 将诊断表后来的诊断结果写入预测表中
(
SELECT
	"PROBABLITY",
	"CHECKTIME",
	"RECORDID"
FROM
	"YJ_WARNING_DIAGNOSIS" D -- 诊断表格d
WHERE
	D ."PIPEID" = P ."PIPEID" -- 插入必须3个条件都对齐才行
AND D ."FAULTTYPE" = P ."FAULTTYPE"
AND D ."RECORDID" = P ."RECORDID"
)
WHERE P."DIAGPROB" IS NULL -- 针对诊断结果为空的行（大大节省时间）
AND P."RECORDID" IN    -- 针对诊断记录中包含预测记录的行（忽略还没诊断的预测）
(SELECT DISTINCT "RECORDID" FROM "YJ_WARNING_DIAGNOSIS"); 

COMMIT;



-- 更新"iscorrect"列
UPDATE "YJ_WARNING_FORECAST" --- 更新为1 0；1为准确，0为不准确
SET "ISCORRECT" = 
	CASE
	WHEN	"DIAGPROB">="PROBABLITY"-"PROBBIAS"
	AND	"DIAGPROB"<="PROBABLITY"+"PROBBIAS"
	THEN 1
	ELSE 0
	END
WHERE "ISCORRECT" IS NULL -- 针对iscorrect为空且diag_prob不为空的情况
AND "DIAGPROB" IS NOT NULL;

COMMIT;

-- 更新"precision"列
UPDATE "YJ_WARNING_FORECAST"
SET "PRECISION"=
(
SELECT
	SUM("ISCORRECT")/COUNT("ISCORRECT")
FROM
	"YJ_WARNING_FORECAST" 
WHERE
	"ISCORRECT" IS NOT NULL
)
WHERE
	"ISCORRECT" IS NOT NULL
	-- AND "PIPEID"=(SELECT MAX("PIPEID") FROM "YJ_WARNING_FORECAST") -- 在诊断记录的最后一行写入精度值
	-- AND "RECORDID"=(SELECT MAX("RECORDID") FROM "YJ_WARNING_FORECAST");

COMMIT;

EXIT;
