
DECLARE
	MAX_RECORDID VARCHAR2 (255) ; 
	MAX_ALARMTIME TIMESTAMP ;
BEGIN
	SELECT MAX(RECORDID) INTO MAX_RECORDID FROM "YJ_WARNING_FORECAST" ; 
	SELECT MAX(ALARMTIME) INTO MAX_ALARMTIME FROM "YJ_WARNING_ALARMPIPE" ;
	
	-- 在诊断表中筛出发生故障的点送到报警表中
	INSERT INTO "YJ_WARNING_ALARMPIPE" (
		"DBID",
		"ACTIVE",
		"ALARMTIME",
		"FAULTDESC",
		"FAULTTYPE",
		"PROBABLITY",
		"PIPEID"
	) SELECT
		SEQ_YJ_WARNING_ALARMPIPE.nextval,
		'1',
		"CHECKTIME",
		"FAULTDESC",
		"FAULTTYPE",
		"PROBABLITY",
		"PIPEID"
	FROM
		"YJ_WARNING_FORECAST"
	WHERE
		-- 在预测表中挑出最近1次的预测结果
		RECORDID = MAX_RECORDID
		-- 并且recordid不能与目标中相同，防止重复写入
		AND (CHECKTIME != MAX_ALARMTIME OR MAX_ALARMTIME IS NULL)
		-- 不正常的才写入预警
		AND ISNORMAL = '0';  
	
END ;
/
